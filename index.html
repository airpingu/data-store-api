<!DOCTYPE html>
<html>
  <head>
    <title>Data Store API</title>
    <meta charset='utf-8'>
    <script src='https://www.w3.org/Tools/respec/respec-w3c-common'
            async class='remove'></script>
    <script class="remove">
      var respecConfig = {
        specStatus:          "ED",
        shortName:           "Data Store API", // needed for generated URLs
        editors: [{
          name: "Gene Lian",
          company: "Mozilla",
          companyURL: "http://www.mozilla.org",
          mailto: "clian@mozilla.com"
        }],
        publishDate:         "", // no needed for "ED" or "unofficial"
        edDraftURI:          "http://airpingu.github.io/data-store-api/index.html", // needed for "ED"
        previousPublishDate: "", // needed for "WD", "LC", "CR"
        previousMaturity:    "", // needed for "WD", "LC", "CR"
        lcEnd:               "", // needed for "LC"
        crEnd:               "", // needed for "CR"
        wg:           "System Applications Working Group",
        wgURI:        "http://www.w3.org/2012/sysapps/",
        wgPublicList: "public-sysapps",
        wgPatentURI:  "http://www.w3.org/2004/01/pp-impl/43696/status",
        otherLinks: [{
          key: "Repository",
          data: [{
            value: "We are on GitHub.",
            href: "https://github.com/airpingu/data-store-api/"
          }, {
            value: "File a bug.",
            href: "https://github.com/airpingu/data-store-api/issues"
          }, {
            value: "Commit history.",
            href: "https://github.com/airpingu/data-store-api/commits/gh-pages"
          }]
        }],
        inlineCSS:    true,
        noIDLIn:      true,
        noIDLSorting: true
      };
    </script>
  </head>

<!-----------------------------------------------------------------------------
Style guide to contributors:
============================
- this document uses ReSpec, see
  http://dev.w3.org/2009/dap/ReSpec.js/documentation.html
- use 80 characters wide lines, whenever possible (except long links)
- keep sections 2 empty lines apart
- put comments in front of sections, for better readability with syntax coloring
  editors
- use indentation with care: it may improve readability, but at the expense of
  line lenght
- when descriptions of attributes is short, use the <dd> elements even when
  the text also contains conformance statements (e.g. MUST, SHOULD, MAY).
  No use repeating the same information in a separate paragraph.
------------------------------------------------------------------------------>
 
  <body>

<!-- - - - - - - - - - - - - - - Abstract  - - - - - - - - - - - - - - - - - -->    
    <section id="abstract">
      The Data Store API allows an application to manage a data store that can
      be shared with other applications and provides a mechanism to allow
      multiple applications to concurrently synchronize data from the data store
      into the application-local cache.
    </section>

<!-- - - - - - - - - - - - - - - Status of this document - - - - - - - - - - -->   
    <section id="sotd">
    </section>
    
<!-- - - - - - - - - - - - - - - Introduction  - - - - - - - - - - - - - - - -->
    <section class="informative">
      <h2>Introduction</h2>
      <p>
        The Data Store API allows an application to create and maintain a data
        store that can be shared with other applications. To make multiple
        applications keep their local storages up-to-date with the data store,
        this API supports a mechanism to allow an application to concurrently
        synchronize data from the data store into the application-local storage
        which can be indexed, grouped or sorted in whatever format the
        application needs in order to support its UI.
      </p>

      <section>
        <h3>Motivation</h3>
        <p>
          The Contacts Manager API and the Messaging API were originally
          designed to support richer querying, like filtering, sorting and
          grouping data. However, they both have the severe shortcoming that the
          consumers are forced to live with the limitations of what querying
          capabilities those APIs can have.
        </p>
        <p>
          That's why we are constantly having to revise these APIs because it
          turns out that the querying capabilities aren't matching what our
          applications need, which is not a workable long-term solution. Also,
          it's not even a workable short-term solution for third-party
          applications since we cannot revise the APIs to support the
          capabilities that every third-party application developer needs.
        </p>
        <p>
          Therefore, we've been figuring out such a generic Data Store API to
          allow applications to synchronize and save data into their own
          application-local storages which can be managed in various formats
          than we could think of and bake into APIs, thus supporting richer
          querying capabilities that the application really needs.
        </p>
        <p>
          Note that the Data Store API is still in charge of maintaining a
          central storage to keep data which can be added, retrieved or deleted
          by applications through a bunch of methods provided by the Data Store
          API. This implies the application doesn't need to duplicate the whole
          data in its own local storage. Instead, it can simply synchronize the
          data that is actively required to construct the needed indexes for its
          own querying purpose.
        </p>
      </section>

      <section>
        <h3>More than IndexedDB API</h3>
        <p>
          Similar to the IndexedDB API, the Data Store API provides some
          database-like methods to add, retrieve and delete data records but it
          doesn't expose methods for building indexes or searching data.
          Instead, it provides a synchronizing mechanism for applications to
          keep their local storages up-to-date and accordingly update the
          local indexes needed for filtering data.
        </p>
        <p>
          The other difference from the IndexedDB API is the Data Store API
          provides a central data storage which can be concurrently accessed and
          modified by multiple applications. Also, it provides a permission
          model to allow different applications to have different types of
          priviledges to change the data store or listen to the change of the
          data store.
        </p>
      </section>

      <section>
        <h3>Examples</h3>
        <p>
          If an application has the privilege to modify the content of the data
          store, it can use a bunch of basic methods defined in the
          <a>DataStore</a> to manage the data records in the data store, which is
          shown as the following example.
        </p>

        <pre class="example highlight">
          // Retrieve a list of data stores named as 'contacts'.
          navigator.getDataStores('contacts').then(function(stores) {
            if (!stores.length) {
              return;
            }

            // Check if the application is allowed to modify the data store.
            if (stores[0].readOnly) {
              return;
            }

            // Retrieve an object.
            stores[0].get(42).then(function(obj) {
              // Update the object
              obj.name = 'foo';
              stores[0].update(42, obj).then(function(id) {
                // The object has been updated.
              }, function(error) {
                // The object fails to be updated.
              });
            });
      
            // Delete an object.
            stores[0].remove(23).then(function(success) {
              if (success) {
                // The object has been deleted.
              } else {
                // The object fails to be deleted.
              }
            });
      
            // Add a new object.
            stores[0].insert({ name: "bar" }).then(function(id) {
              // The object has been added.
            }, function(error) {
              // The object fails to be added.
            });
          });
        </pre>

        <p>
          An application can call the <code>sync()</code> method defined in the
          <a>DataStore</a> to keep its local storage synchronized with the data
          store, which creates a <a>DataStoreCursor</a> to retrieve the change
          history starting from a certain revision kept in the application to the
          current revision of the data store, which is shown as the following
          example.
        </p>
        <pre class="example highlight">
          var appLocalRevisionId = "revision_id_kept_by_app";

          // Retrieve a list of data stores named as 'contacts'.
          navagiator.getDataStores('contacts').then(functions(stores) {
            if (!stores.length) {
              return;
            }

            // Check if the application's local storage is out-of-date.
            if (appLocalRevisionId == stores[0].revisionId) {
              dump("The app's local storage is already in sync.\n");
              return;
            }
   
            var cursor = stores[0].sync(appLocalRevisionId);
   
            function cursorResolve(task) {
              switch (task.operation) {
                case 'done':
                  // All the data are in sync. Update the local revision ID.
                  dump("The current revision ID: " + task.revisionId + "\n");
                  appLocalRevisionId = task.revisionId;
                  return;

                case 'clear':
                  // All the data have to be deleted in the local storage.
                  break;

                case 'add':
                  // A new object has to be added in the local storage.
                  dump("Add ID: " + task.id + " data: " + task.data + "\n");
                  break;

                case 'update':
                  // An object has to be updated in the local storage.
                  dump("Update ID: " + task.id + " data: " + task.data + "\n");
                  break;

                case 'remove':
                  // An object has to be deleted in the local storage.
                  dump("Remove ID: " + task.id + " data: " + task.data + "\n");
                  break;
              }

              cursor.next().then(cursorResolve);
            }
   
            // Start to sync.
            cursor.next().then(cursorResolve);
          });
        </pre>
      </section>
    </section>
    
<!-- - - - - - - - - - - - - - - Conformance - - - - - - - - - - - - - - - - -->
    <section id="conformance">
      <p>
        This specification defines conformance criteria that apply to a single
        product: the <dfn>user agent</dfn> that implements the interfaces that
        it contains.
      </p>
    
      <p>
        Implementations that use ECMAScript to implement the APIs defined in
        this specification MUST implement them in a manner consistent with the
        ECMAScript Bindings defined in the Web IDL specification [[!WEBIDL]], as
        this specification uses that specification and terminology.
      </p>
    </section>
    
<!-- - - - - - - - - - - - - - - Terminology  - - - - - - - - - - - - - - - -->
    <section>
      <h2>Terminology</h2>
      <p>
        The <dfn><a
        href="http://dev.w3.org/html5/spec/webappapis.html#eventhandler">
        EventHandler</a></dfn> interface represents a callback used for event
        handlers as defined in [[!HTML5]].
      </p>
    
      <p>
        The concepts <dfn><a
        href="http://dev.w3.org/html5/spec/webappapis.html#queue-a-task"> queue
        a task</a></dfn> and <dfn><a
        href="http://dev.w3.org/html5/spec/webappapis.html#fire-a-simple-event">
        fire an event</a></dfn> are defined in [[!HTML5]].
      </p>
    
      <p>
        The terms <a
        href="http://dev.w3.org/html5/spec/webappapis.html#event-handlers"><dfn
        id="dfn-eventhandler">event handler</dfn></a> and <a
        href="http://dev.w3.org/html5/spec/webappapis.html#event-handler-event-type">
        <dfn id="dfn-eventtypes"> event handler event types</dfn></a> are
        defined in [[!HTML5]].
      </p>
    
      <p>
        The <dfn><a href="http://dom.spec.whatwg.org/#promise">Promise</a></dfn>
        interface, the concepts of a <a href=
        "http://dom.spec.whatwg.org/#concept-resolver"><dfn>resolver</dfn></a>, a
        <dfn id="dfn-fulfill-algorithm"><a
        href="http://dom.spec.whatwg.org/#concept-resolver-fulfill"> resolver's
        fulfill algorithm</a></dfn> and a <dfn id="dfn-reject-algorithm"><a
        href="http://dom.spec.whatwg.org/#concept-resolver-reject"> resolver's
        reject algorithm</a></dfn> are defined in [[DOM4]].
      </p>
    </section>

<!-- - - - - - - - - - - - - - - Security and privacy  - - - - - - - - - - - -->
    <section>
      <h2>Security and privacy considerations</h2>
      <section>
        <h3>Application Manifest</h3>
        <p>
          For the application that provides the data store, its manifest MUST be
          claimed to own the data store by <code>datastores-owned</code>, where
          the JSON object can contain multiple properties representing different
          types of data stores respectively. Each data store can use
          <code>readonly</code> to specify whether the data store can be read by
          other applications and <code>description</code> to describe the
          purpose.
        </p>

        <p>
          As shown as the following example, if a Facebook applicaton wants to
          provide a read-only <em>contacts</em> data store, its manifest MUST be
          claimed to own the data store by setting the attribute
          <code>readonly</code> to <em>true</em>.
        </p>
        <pre class="example highlight">
          {
            datastores-owned: {
              "contacts": {
                "readonly": true,
                "description": "own the Facebook contacts data store"
              }
            }
          }
        </pre>

        <p>
          For the application that wants to access the data store, its manifest
          MUST be claimed to access the data store by
          <code>datastores-access</code>, where the JSON object can contain
          multiple properties representing different types of data stores
          respectively. Each data store can use <code>access</code> to specify
          the application's accessibility and <code>description</code> to
          describe the purpose.
        </p>

        <p>
          As shown as the following example, if the application wants to read or
          modify (e.g., add, update, remove, clear... etc) the content of the
          <em>contacts</em> data store, its manifest MUST be claimed to access
          the <em>contacts</em> data store by setting the attribute
          <code>access</code> to <em>readwrite</em>.
        </p>
        <pre class="example highlight">
          {
            datastores-access: {
              "contacts": {
                "access": "readwrite",
                "description": "access (read and write) the contacts data stores"
              }
            }
          }
        </pre>

        <p>
          As shown as the following example, if the application simply wants to
          read the content of the <em>contacts</em> data store without the need
          of modifying it, its manifest MUST be claimed to access the
          <em>contacts</em> data store by setting the attribute
          <code>access</code> to <em>readonly</em>.
        </p>
        <pre class="example highlight">
          {
            datastores-access: {
              "contacts": {
                "access": "readonly",
                "description": "access (read only) the contacts data store"
              }
            }
          }
        </pre>
      </section>

      <section>
        <h3>Permission Model</h3>
        <p>
          The Data Store API can be exposed to trusted or untrusted contents.
        </p>
        <div class='note'>
          Need to define the permission model of how the privileged and the
          third-party applications can be allowed to use the Data Store API to
          access the data store.
        </div>
      </section>
    </section>

<!-- - - - - - - - - - - - - Extended Interface Navigator  - - - - - - - - - -->
    <section>
      <h2><a>Navigator</a> Interface</h2>
        <dl title="partial interface Navigator" class="idl">
          <dt>Promise getDataStores ()</dt>
            <dd>
              This method makes a request to retrieve the data stores by the
              <code>type</code> parameter. It returns a new
              <code>Promise</code> that will be used to notify the caller about
              the result of the operation, which is an array of <a>DataStore</a>
              elements to access the data stores which have the same type equal
              to the <code>type</code>.
              <dl class='parameters'>
                <dt>DOMString type</dt>
                  <dd>Specifies the type of the data store.</dd>
              </dl>
            </dd>
        </dl>

      <section>
        <h3>Steps</h3>
        <p>
          The <dfn><code>getDataStores</code></dfn> method when invoked MUST run
          the following steps:
        </p>
        <ol>
          <li>
            Let <var>promise</var> be a new <code>Promise</code> object and
            <var>resolver</var> be its associated <code>resolver</code>.
          </li>
          <li>
            Return <var>promise</var> to the caller.
          </li>
          <li>
            Make a request to the system to retrieve the data store(s) with the
            type equal to the <code>type</code> parameter passed in the
            request, where the caller application has claimed the data store
            access by <code>datastores-access</code> in its manifest.
          </li>
          <li>
            If an <var>error</var> occurs invoke <em>resolver</em>'s <a
            class="internalDFN" href="#dfn-reject-algorithm">reject algorithm</a>
            with <em>error</em> as the <code>value</code> argument.
          </li>
          <li>
            When the request has been successfully completed:
          </li>
          <ol>
            <li>
              Let <var>dataStores</var> be the array of the retrieved
              <a>DataStore</a> elements.
            </li>
            <li>
              Invoke <em>resolver</em>'s <a
              class="internalDFN" href="#dfn-fulfill-algorithm"> fulfill algorithm</a>
              with <em>dataStores</em> as the <code>value</code> argument.
            </li>
          </ol>
        </ol>
      </section>
    </section>

<!-- - - - - - - - - - - - - Interface DataStore  - - - - - - - - - - - - - -->
    <section>
      <h2><a>DataStore</a> Interface</h2>
      <p>
        The <a>DataStore</a> interface represents a bunch of properties of the
        data store and a set of operations that can be used to manage and
        synchronize the content of the data store.
      </p>

      <div title="typedef (DOMString or unsigned long) DataStoreKey" class='idl'></div>

      <dl title="interface DataStore : EventTarget" class="idl">
        <dt>readonly attribute DOMString <a>type</a></dt>
          <dd>
            MUST return the type of the data store. Note that different data
            stores can share the same type. For example, the Facebook contacts
            data store and the built-in SMS/MMS contacts data store can have the
            same type <em>contacts</em>.
          </dd>
      
        <dt>readonly attribute DOMString owner</dt>
          <dd>
            MUST return the owner of the data store, which can be the manifest
            URL of the owner application.
          </dd>

        <dt>readonly attribute boolean readOnly</dt>
          <dd>
            MUST return whether the content of the data store can be changed or
            not by the caller.
          </dd>

        <dt>readonly attribute DOMString revisionId</dt>
          <dd>
            MUST return the current revision of the data store, which can be a
            UUID string.
          </dd>
      
        <dt>Promise get ()</dt>
          <dd>
            This method makes a request to retrieve the data record(s) by the
            <code>id</code> parameter. It returns a new <code>Promise</code>
            that will be used to notify the caller about the result of the
            operation, which is an arbitrary object to represent the data
            record if <code>id</code> is a single value, or a set of data
            records if <code>id</code> is an array of values.
            <dl class='parameters'>
              <dt>DataStoreKey... id</dt>
                <dd>
                  Identifies the data record(s) that is requested to be
                  retrieved.
                </dd>
            </dl>
          </dd>

        <dt>Promise update ()</dt>
          <dd>
            This method makes a request to update the existing data record by
            the <code>id</code> and the <code>data</code> parameters. It returns
            a new <code>Promise</code> that will be used to notify the caller
            about the result of the operation.
            <dl class='parameters'>
              <dt>DataStoreKey id</dt>
                <dd>
                  Identifies the data record that is requested to be updated.
                </dd>
              <dt>any data</dt>
                <dd>
                  Specifies the content of the data record to update.
                </dd>
            </dl>
          </dd>

        <dt>Promise insert ()</dt>
          <dd>
            This method makes a request to add a new data record by the
            <code>data</code> parameter. It returns a new <code>Promise</code>
            that will be used to notify the caller about the result of the
            operation, which is an identifier to access the data record that is
            added.
            <dl class='parameters'>
              <dt>any data</dt>
                <dd>
                  Specifies the content of the data record to add.
                </dd>
            </dl>
          </dd>

        <dt>Promise remove ()</dt>
          <dd>
            This method makes a request to delete the data record(s) by the
            <code>id</code> parameter. It returns a new <code>Promise</code>
            that will be used to notify the caller about the result of the
            operation, which is a boolean value to indicate whether the data
            record(s) is successfully deleted or not.
            <dl class='parameters'>
              <dt>DataStoreKey... id</dt>
                <dd>
                  Identifies the data record(s) that is requested to be deleted.
                </dd>
            </dl>
          </dd>

        <dt>Promise clear ()</dt>
          <dd>
            This method makes a request to clear all the data records in the
            data store. It returns a new <code>Promise</code> that will be used
            to notify the caller about the result of the operation.
          </dd>

        <dt>Promise getLength ()</dt>
          <dd>
            This method makes a request to retrieve the total number of data
            records saved in the data store. It returns a new
            <code>Promise</code> that will be used to notify the caller about
            the result of the operation, which is a numeric value to indicate
            the total number of data records saved in the data store.
          </dd>

        <dt>DataStoreCursor sync ()</dt>
          <dd>
            This method makes a request to retrieve the change history between a
            particular revision and the current revision of the data store by the
            <code>revisionId</code> parameter. It returns a new
            <a>DataStoreCursor</a> that will be used to iteratively access a set
            of <a>DataStoreTask</a> elements.
            <dl class='parameters'>
              <dt>optional DOMString revisionId</dt>
                <dd>
                  Identifies the revision of the data store that the application
                  currently keeps. If this parameter is absent or cannot be
                  identified, this method will return a <a>DataStoreCursor</a>
                  iterating through all the existing data records currently
                  saved in the data store.
                </dd>
            </dl>
          </dd>

        <dt class="no-docs">
          attribute EventHandler onchange
        </dt>
          <dd>
            Handles the <code>change</code> event of type
            <a>DataStoreChangeEvent</a>, fired when a data record is added,
            updated or deleted in the data store. Note that if some data change
            in the data store when the <a>DataStoreCursor</a> is still
            synchronizing data and the cursor's <a><code>close</code></a> method
            has not yet been called, all the change events will not be
            dispatched to the application's <code>onchange</code> event handler.
            Instead, all the changes will be managed by the cursor's
            <a><code>next</code></a> method as additional operations.
          </dd>
      </dl>

      <section>
        <h3>Steps</h3>
        <p>
          The <dfn><code>get</code></dfn> method when invoked MUST run the
          following steps:
        </p>
        <ol>
          <li>
            Let <var>promise</var> be a new <code>Promise</code> object and
            <var>resolver</var> be its associated <code>resolver</code>.
          </li>
          <li>
            Return <var>promise</var> to the caller.
          </li>
          <li>
            Make a request to the data store to retrieve the data record(s) with
            the identifier equal to the <code>id</code> parameter passed in the
            request.
          </li>
          <li>
            If an <var>error</var> occurs invoke <em>resolver</em>'s <a
            class="internalDFN" href="#dfn-reject-algorithm">reject algorithm</a>
            with <em>error</em> as the <code>value</code> argument.
          </li>
          <li>
            When the request has been successfully completed:
          </li>
          <ol>
            <li>
              Let <var>dataRecord</var> be the retrieved data record(s).
            </li>
            <li>
              Invoke <em>resolver</em>'s <a
              class="internalDFN" href="#dfn-fulfill-algorithm"> fulfill algorithm</a>
              with <em>dataRecord</em> as the <code>value</code> argument.
            </li>
          </ol>
        </ol>

        <p>
          The <dfn><code>update</code></dfn> method when invoked MUST run the
          following steps:
        </p>
        <ol>
          <li>
            Let <var>promise</var> be a new <code>Promise</code> object and
            <var>resolver</var> be its associated <code>resolver</code>.
          </li>
          <li>
            Return <var>promise</var> to the caller.
          </li>
          <li>
            If the <code>readOnly</code> attribute of the current data store is
            <em>true</em> to the caller, invoke <em>resolver</em>'s <a
            class="internalDFN" href="#dfn-reject-algorithm">reject algorithm</a>
            without assigning a value to the <code>value</code> argument.
          </li>
          <li>
            Make a request to the data store to retrieve the data record with
            the identifier equal to the <code>id</code> parameter passed in the
            request.
          </li>
          <li>
            If an <var>error</var> occurs invoke <em>resolver</em>'s <a
            class="internalDFN" href="#dfn-reject-algorithm">reject algorithm</a>
            with <em>error</em> as the <code>value</code> argument.
          </li>
          <li>
            When the request has been successfully completed:
          </li>
          <ol>
            <li>
              Let <var>dataRecord</var> be the retrieved data record.
            </li>
            <li>
              Replace <em>dataRecord</em> by the <code>data</code> parameter
              passed in the request.
            </li>
            <li>
              Make a request to the data store to save <em>dataRecord</em> back
              to the data store.
            </li>
            <li>
              If an <var>error</var> occurs invoke <em>resolver</em>'s <a
              class="internalDFN" href="#dfn-reject-algorithm">reject algorithm</a>
              with <em>error</em> as the <code>value</code> argument.
            </li>
            <li>
              When the request has been successfully completed:
            </li>
            <ol>
              <li>
                Invoke <em>resolver</em>'s <a
                class="internalDFN" href="#dfn-fulfill-algorithm"> fulfill algorithm</a>
                without assigning a value to the <code>value</code> argument.
              </li>
            </ol>
          </ol>
        </ol>

        <p>
          The <dfn><code>insert</code></dfn> method when invoked MUST run the
          following steps:
        </p>
        <ol>
          <li>
            Let <var>promise</var> be a new <code>Promise</code> object and
            <var>resolver</var> be its associated <code>resolver</code>.
          </li>
          <li>
            Return <var>promise</var> to the caller.
          </li>
          <li>
            If the <code>readOnly</code> attribute of the current data store is
            <em>true</em> to the caller, invoke <em>resolver</em>'s <a
            class="internalDFN" href="#dfn-reject-algorithm">reject algorithm</a>
            without assigning a value to the <code>value</code> argument.
          </li>
          <li>
            Make a request to the data store to add the <code>data</code>
            parameter passed in the request.
          </li>
          <li>
            If an <var>error</var> occurs invoke <em>resolver</em>'s <a
            class="internalDFN" href="#dfn-reject-algorithm">reject algorithm</a>
            with <em>error</em> as the <code>value</code> argument.
          </li>
          <li>
            When the request has been successfully completed:
          </li>
          <ol>
            <li>
              Let <var>id</var> be the generated identifier of the added data
              record.
            </li>
            <li>
              Invoke <em>resolver</em>'s <a
              class="internalDFN" href="#dfn-fulfill-algorithm"> fulfill algorithm</a>
              with <em>id</em> as the <code>value</code> argument.
            </li>
          </ol>
        </ol>

        <p>
          The <dfn><code>remove</code></dfn> method when invoked MUST run the
          following steps:
        </p>
        <ol>
          <li>
            Let <var>promise</var> be a new <code>Promise</code> object and
            <var>resolver</var> be its associated <code>resolver</code>.
          </li>
          <li>
            Return <var>promise</var> to the caller.
          </li>
          <li>
            If the <code>readOnly</code> attribute of the current data store is
            <em>true</em> to the caller, invoke <em>resolver</em>'s <a
            class="internalDFN" href="#dfn-reject-algorithm">reject algorithm</a>
            with <em>false</em> as the <code>value</code> argument.
          </li>
          <li>
            Make a request to the data store to retrieve the data record(s) with
            the identifier equal to the <code>id</code> parameter passed in the
            request.
          </li>
          <li>
            If an <var>error</var> occurs invoke <em>resolver</em>'s <a
            class="internalDFN" href="#dfn-reject-algorithm">reject algorithm</a>
            with <em>false</em> as the <code>value</code> argument.
          </li>
          <li>
            When the request has been successfully completed:
          </li>
          <ol>
            <li>
              Make a request to the data store to delete the data record(s) with
              the identifier equal to the <code>id</code> parameter passed in
              the request.
            </li>
            <li>
              If an <var>error</var> occurs invoke <em>resolver</em>'s <a
              class="internalDFN" href="#dfn-reject-algorithm">reject algorithm</a>
              with <em>false</em> as the <code>value</code> argument.
            </li>
            <li>
              When the request has been successfully completed:
            </li>
            <ol>
              <li>
                Invoke <em>resolver</em>'s <a
                class="internalDFN" href="#dfn-fulfill-algorithm"> fulfill algorithm</a>
                with <em>true</em> as the <code>value</code> argument.
              </li>
            </ol>
          </ol>
        </ol>

        <p>
          The <dfn><code>clear</code></dfn> method when invoked MUST run the
          following steps:
        </p>
        <ol>
          <li>
            Let <var>promise</var> be a new <code>Promise</code> object and
            <var>resolver</var> be its associated <code>resolver</code>.
          </li>
          <li>
            Return <var>promise</var> to the caller.
          </li>
          <li>
            If the <code>readOnly</code> attribute of the current data store is
            <em>true</em> to the caller, invoke <em>resolver</em>'s <a
            class="internalDFN" href="#dfn-reject-algorithm">reject algorithm</a>
            without assigning a value to the <code>value</code> argument.
          </li>
          <li>
            Make a request to the data store to clear all the data records.
          </li>
          <li>
            If an <var>error</var> occurs invoke <em>resolver</em>'s <a
            class="internalDFN" href="#dfn-reject-algorithm">reject algorithm</a>
            with <em>error</em> as the <code>value</code> argument.
          </li>
          <li>
            When the request has been successfully completed:
          </li>
          <ol>
            <li>
              Invoke <em>resolver</em>'s <a
              class="internalDFN" href="#dfn-fulfill-algorithm"> fulfill algorithm</a>
              without assigning a value to the <code>value</code> argument.
            </li>
          </ol>
        </ol>

        <p>
          The <dfn><code>getLength</code></dfn> method when invoked MUST run the
          following steps:
        </p>
        <ol>
          <li>
            Let <var>promise</var> be a new <code>Promise</code> object and
            <var>resolver</var> be its associated <code>resolver</code>.
          </li>
          <li>
            Return <var>promise</var> to the caller.
          </li>
          <li>
            Make a request to the data store to get the total number of data
            records.
          </li>
          <li>
            If an <var>error</var> occurs invoke <em>resolver</em>'s <a
            class="internalDFN" href="#dfn-reject-algorithm">reject algorithm</a>
            with <em>error</em> as the <code>value</code> argument.
          </li>
          <li>
            When the request has been successfully completed:
          </li>
          <ol>
            <li>
              Let <var>length</var> be the total number of data records saved in
              the data store.
            </li>
            <li>
              Invoke <em>resolver</em>'s <a
              class="internalDFN" href="#dfn-fulfill-algorithm"> fulfill algorithm</a>
              with <em>length</em> as the <code>value</code> argument.
            </li>
          </ol>
        </ol>

        <p>
          The <dfn><code>sync</code></dfn> method when invoked MUST run the
          following steps:
        </p>
        <ol>
          <li>
            Make a request to the system to retrieve a cursor that can iterate
            through the change history of the current data store.
          </li>
          <li>
            When the request has been successfully completed:
          </li>
          <ol>
            <li>
              Let <var>dataStoreCursor</var> be a new instance of
              <a>DataStoreCursor</a>.
            </li>
            <li>
              Set the <code>store</code> of <em>dataStoreCursor</em> to the
              current data store.
            </li>
            <li>
              Return <em>dataStoreCursor</em>.
            </li>
          </ol>
        </ol>
      </section>

      <section>
        <h2>Event handlers</h2>
        <p>The following are the <a class="internalDFN"
        href="#dfn-eventhandler">event handlers</a> (and their corresponding <a
        class="internalDFN" href="#dfn-eventtypes">event types</a>) that MUST be
        supported as attributes by the <a>DataStore</a> object.
        
        <table class="simple">
          <thead>
            <tr>
              <th>Event handler</th>
              <th>Event name</th>
              <th>Event type</th>
              <th>Short description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong><code>onchange</code></strong></td>
              <td><code><dfn id="dfn-change-event">change</dfn></code></td>
              <td><a><code>DataStoreChangeEvent</code></a></td>
              <td>
                Handles the information of the data record changed in the data
                store.
              </td>
            </tr>
          </tbody>
        </table>
      </section>

    </section>


<!-- - - - - - - - - - - - Interface DataStoreCursor  - - - - - - - - - - - - - - -->
    <section>
      <h2><a>DataStoreCursor</a> Interface</h2>
      <p>
        The <a>DataStoreCursor</a> interface allows the application to iterate
        through a list of <a>DataStoreTask</a> elements that represents the
        change history of the data store.
      </p>

      <dl title="interface DataStoreCursor" class="idl">
        <dt>readonly attribute DataStore store</dt>
          <dd>
            MUST return the data store that is currently iterated by the cursor.
          </dd>

        <dt>Promise next ()</dt>
          <dd>
            This method makes a request to retrieve the information of the next
            operation that changes a data record in the data store. It returns a
            new <code>Promise</code> that will be used to notify the caller
            about the result of the operation, which is a <a>DataStoreTask</a>
            to represent the information of the change operation.
          </dd>

        <dt>void close ()</dt>
          <dd>
            This method makes a request to terminate the cursor iterating
            through the change history of the data store. Note that this method
            has to be explicitly called when the cursor completes its tasks.
            Otherwise, if some data changes in the data store when the cursor is
            still synchronizing data, all the changes will be managed by the
            cursor's <a><code>next</code></a> method as additional operations,
            which means when the cursor completes its tasks, the application
            will be in synchronization with the current revision of the data
            store.
          </dd>
      </dl>
    
      <section>
        <h3>Steps</h3>
        <p>
          The <dfn><code>next</code></dfn> method when invoked MUST run the
          following steps:
        </p>
        <ol>
          <li>
            Let <var>promise</var> be a new <code>Promise</code> object and
            <var>resolver</var> be its associated <code>resolver</code>.
          </li>
          <li>
            Return <var>promise</var> to the caller.
          </li>
          <li>
            Make a request to the system to retrieve the information of the next
            operation that changes a data record in the data store.
          </li>
          <li>
            If an <var>error</var> occurs invoke <em>resolver</em>'s <a
            class="internalDFN" href="#dfn-reject-algorithm">reject algorithm</a>
            with <em>error</em> as the <code>value</code> argument.
          </li>
          <li>
            When the request has been successfully completed:
          </li>
          <ol>
            <li>
              Let <var>dataStoreTask</var> be a new instance of
              <a>DataStoreTask</a>:
            </li>
            <ol>
              <li>
                Set the <code>revisionId</code> of <em>dataStoreTask</em> to the
                revision of the data store, which changes a data record.
              </li>
              <li>
                Set the <code>id</code> of <em>dataStoreTask</em> to the
                identifier of the changed data record in the data store.
              </li>
              <li>
                Set the <code>operation</code> of <em>dataStoreTask</em> to the
                type of operation that changes the data record in the data store.
              </li>
              <li>
                Set the <code>data</code> of <em>dataStoreTask</em> to the
                changed data record in the data store.
              </li>
            </ol>
            <li>
              Invoke <em>resolver</em>'s <a
              class="internalDFN" href="#dfn-fulfill-algorithm"> fulfill algorithm</a>
              with <em>dataStoreTask</em> as the <code>value</code> argument.
            </li>
          </ol>
        </ol>

        <p>
          The <dfn><code>close</code></dfn> method when invoked MUST run the
          following steps:
        </p>
        <ol>
          <li>
            Make a request to the system to terminate the current cursor
            iterating through the change history of the data store.
          </li>
        </ol>
      </section>
    </section>


<!-- - - - - - - - - - - - Dictionary DataStoreTask  - - - - - - - - - - - - -->
    <section>
      <h2><a>DataStoreTask</a> Dictionary</h2>
      <p>
        The <a>DataStoreTask</a> dictionary contains the information related to
        a data record changed in the data store.
      </p>
      <dl title="dictionary DataStoreTask" class="idl">
        <dt>DOMString revisionId</dt>
          <dd>
            MUST return the identifier of the revision of the data store, which
            changes a data record.
          </dd>

        <dt>DataStoreOperation operation</dt>
          <dd>
            MUST return the type of operation that changes the data record in
            the data store.
          </dd>

        <dt>DataStoreKey? id</dt>
          <dd>
            MUST return the identifier of the changed data record in the data
            store. MUST return <em>null</em> if the <code>operation</code>
            is <em>clear</em> or <em>done</em>.
          </dd>

        <dt>any data</dt>
          <dd>
            MUST return an arbitrary object to represent the changed data record
            in the data store. MUST return <em>null</em> if the
            <code>operation</code> is <em>clear</em> or <em>done</em>.
          </dd>
      </dl>
    </section>

<!-- - - - - - - - - - - - Interface DataStoreChangeEvent - - - - - - - - - - -->
    <section>
      <h2><a>DataStoreChangeEvent</a> Interface</h2>
      <p>
        The <a>DataStoreChangeEvent</a> interface represents the event related
        to a date record changed in the data store.
      </p>
      <dl title="interface DataStoreChangeEvent : Event" class="idl">
        <dt>readonly attribute DOMString revisionId</dt>
          <dd>
            MUST return the identifier of the revision of the data store, which
            changes a data record.
          </dd>

        <dt>readonly attribute DataStoreOperation operation</dt>
          <dd>
            MUST return the type of operation that changes the data record in
            the data store.
          </dd>

        <dt>readonly attribute DataStoreKey? id</dt>
          <dd>
            MUST return the identifier of the changed data record in the data
            store. MUST return <em>null</em> if the <code>operation</code> is
            <em>clear</em> or <em>done</em>.
          </dd>

        <dt>readonly attribute DOMString owner</dt>
          <dd>
            MUST return the manifest URL of the application which changes the
            data record in the data store. Note that the <code>owner</code> here
            is not the owner application of the data store. Instead, it's the
            application making the change in the data store.
          </dd>
      </dl>
    </section>

<!-- - - - - - - - - - - - Interface Enumerations  - - - - - - - - - - - - - -->
    <section>
      <h2>Enumerations</h2>
      <p>
        The attribute <code>operation</code> in a <a>DataStoreTask</a> or
        a <a>DataStoreChangeEvent</a> can have the following values:
      </p>
      <dl title="enum DataStoreOperation" class="idl">
        <dt>add</dt>
        <dd>
          The data record is added in the data store.
        </dd>

        <dt>update</dt>
        <dd>
          The data record is updated in the data store.
        </dd>

        <dt>remove</dt>
        <dd>
          The data record is deleted in the data store.
        </dd>

        <dt>clear</dt>
        <dd>
          All the data records are deleted in the data store.
        </dd>

        <dt>done</dt>
        <dd>
          No additional opreations in the data store.
        </dd>
      </dl>
    </section>

<!-- - - - - - - - - - - - Acknowledgements  - - - - - - - - - - - - - - - - -->
    <section>
      <h2>Acknowledgements</h2>
      <p>
        The editors would like to express their gratitude to the Mozilla Firefox
        OS Team and specially to Jonas Sicking, Mounir Lamouri, Ehsan Akhgari,
        Thinker Lee and Hsin-Yi Tsai for their technical guidance, as well as to
        Andrea Marchesini for his implementation work and support. Also, huge
        thanks to Zoltan Kis (Intel) and Christophe Dumez (Samsung) for their
        suggestions and contributions to this specification.
      </p>
    </section>

  </body>
</html>
